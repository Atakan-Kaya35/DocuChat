# =============================================================================
# DocuChat Infrastructure - Docker Compose (Phase 1)
# =============================================================================
# Infrastructure services for smoke testing.
# Usage:
#   docker compose up -d postgres redis
#   docker compose up -d ollama
#   docker compose up -d keycloak nginx
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # POSTGRES - Database with pgvector extension
  # ---------------------------------------------------------------------------
  postgres:
    image: pgvector/pgvector:pg16
    container_name: docuchat-postgres
    env_file:
      - .env.sample
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-docuchat}
      POSTGRES_USER: ${POSTGRES_USER:-docuchat}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-change_me}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-docuchat} -d ${POSTGRES_DB:-docuchat}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - docuchat_net
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # PSQL - Temporary PostgreSQL client (for testing)
  # ---------------------------------------------------------------------------
  psql:
    image: pgvector/pgvector:pg16
    container_name: docuchat-psql
    profiles:
      - tools
    environment:
      PGPASSWORD: ${POSTGRES_PASSWORD:-change_me}
    networks:
      - docuchat_net
    entrypoint: ["psql"]

  # ---------------------------------------------------------------------------
  # REDIS - Message Broker & Cache
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: docuchat-redis
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    networks:
      - docuchat_net
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # OLLAMA - Local LLM Inference
  # ---------------------------------------------------------------------------
  ollama:
    image: ollama/ollama:latest
    container_name: docuchat-ollama
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - docuchat_net
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # CURL - Temporary HTTP client (for testing internal connectivity)
  # ---------------------------------------------------------------------------
  curl:
    image: curlimages/curl:latest
    container_name: docuchat-curl
    profiles:
      - tools
    networks:
      - docuchat_net
    entrypoint: ["curl"]

  # ---------------------------------------------------------------------------
  # KEYCLOAK - Identity & Access Management
  # ---------------------------------------------------------------------------
  keycloak:
    image: quay.io/keycloak/keycloak:25.0
    container_name: docuchat-keycloak
    command: ["start-dev", "--import-realm"]
    env_file:
      - .env.sample
    environment:
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-change_me}
    volumes:
      - ./keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json:ro
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/127.0.0.1/8080;echo -e 'GET /health/ready HTTP/1.1\\r\\nhost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3;if timeout 5 grep -q '200 OK' <&3; then exit 0; else exit 1; fi"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - docuchat_net
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # NGINX - Reverse Proxy
  # ---------------------------------------------------------------------------
  nginx:
    image: nginx:alpine
    container_name: docuchat-nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - keycloak
      - backend
      - frontend
    networks:
      - docuchat_net
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # FRONTEND - React/Vite Application
  # ---------------------------------------------------------------------------
  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
    container_name: docuchat-frontend
    networks:
      - docuchat_net
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # BACKEND - Django API Server
  # ---------------------------------------------------------------------------
  backend:
    build:
      context: ../backend
      dockerfile: Dockerfile
    container_name: docuchat-backend
    env_file:
      - ../backend/.env.sample
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      keycloak:
        condition: service_started
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/api/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - docuchat_net
    restart: unless-stopped

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  docuchat_net:
    driver: bridge
    name: docuchat_net

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  postgres_data:
    name: docuchat_postgres_data

  redis_data:
    name: docuchat_redis_data

  ollama_data:
    name: docuchat_ollama_data
