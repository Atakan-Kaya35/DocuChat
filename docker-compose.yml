# =============================================================================
# DocuChat - Docker Compose Configuration
# =============================================================================
# All services run on internal network. Only nginx exposes port 80.
# Copy .env.sample files to .env and configure before running.
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # NGINX - Reverse Proxy (only exposed service)
  # ---------------------------------------------------------------------------
  nginx:
    image: nginx:alpine
    container_name: docuchat-nginx
    ports:
      - "80:80"
    volumes:
      - ./infra/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      frontend:
        condition: service_started
      backend:
        condition: service_healthy
    networks:
      - docuchat_net
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # FRONTEND - React/Vite Application
  # ---------------------------------------------------------------------------
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: docuchat-frontend
    env_file:
      - ./frontend/.env.sample
    networks:
      - docuchat_net
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # BACKEND - Django API Server
  # ---------------------------------------------------------------------------
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: docuchat-backend
    env_file:
      - ./backend/.env.sample
    volumes:
      - backend_uploads:/data/uploads
      - backend_extracted:/data/extracted
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      keycloak:
        condition: service_healthy
      ollama-init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/readyz', timeout=5)"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 60s
    networks:
      - docuchat_net
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # WORKER - Background Indexing Worker (uses same image as backend)
  # ---------------------------------------------------------------------------
  worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: docuchat-worker
    command: ["python", "manage.py", "run_worker"]
    env_file:
      - ./backend/.env.sample
    volumes:
      - backend_uploads:/data/uploads
      - backend_extracted:/data/extracted
    depends_on:
      backend:
        condition: service_healthy
      ollama-init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "sh", "-c", "test -f /tmp/worker_heartbeat && find /tmp/worker_heartbeat -mmin -1 | grep -q ."]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      - docuchat_net
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # POSTGRES - Database with pgvector extension
  # ---------------------------------------------------------------------------
  postgres:
    image: pgvector/pgvector:pg16
    container_name: docuchat-postgres
    env_file:
      - ./infra/.env.sample
    # Required env vars in .env:
    #   POSTGRES_USER=docuchat
    #   POSTGRES_PASSWORD=<secure_password>
    #   POSTGRES_DB=docuchat
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./infra/postgres/initdb:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER:-postgres} -d $${POSTGRES_DB:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - docuchat_net
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # REDIS - Message Broker & Cache
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: docuchat-redis
    # Optional: mount custom config
    # volumes:
    #   - ./infra/redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    # command: ["redis-server", "/usr/local/etc/redis/redis.conf"]
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    networks:
      - docuchat_net
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # KEYCLOAK - Identity & Access Management
  # ---------------------------------------------------------------------------
  keycloak:
    image: quay.io/keycloak/keycloak:25.0
    container_name: docuchat-keycloak
    command: ["start-dev", "--import-realm"]
    env_file:
      - ./infra/.env.sample
    # Required env vars in .env:
    #   KEYCLOAK_ADMIN=admin
    #   KEYCLOAK_ADMIN_PASSWORD=<secure_password>
    #   KC_DB=postgres
    #   KC_DB_URL=jdbc:postgresql://postgres:5432/keycloak
    #   KC_DB_USERNAME=<db_user>
    #   KC_DB_PASSWORD=<db_password>
    environment:
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-change_me}

    volumes:
      - ./infra/keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json:ro
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -c '</dev/tcp/127.0.0.1/8080' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 15
      start_period: 60s
    networks:
      - docuchat_net
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # OLLAMA - Local LLM Inference (internal only, no exposed ports)
  # ---------------------------------------------------------------------------
  ollama:
    image: ollama/ollama:latest
    container_name: docuchat-ollama
    # No ports exposed - internal access only via docuchat_net
    # Other services connect via http://ollama:11434
    volumes:
      # Bind mount to local folder - models persist even if volume is deleted
      - ./infra/ollama/models:/root/.ollama
    healthcheck:
      # Use ollama CLI to verify server is ready
      test: ["CMD", "ollama", "list"]
      interval: 10s
      timeout: 600s
      retries: 5
      start_period: 10s
    networks:
      - docuchat_net
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # OLLAMA-INIT - Model Puller & Warmup (runs once, then exits)
  # ---------------------------------------------------------------------------
  # This service ensures models are downloaded and loaded into VRAM before
  # other services start using Ollama. It pulls models and sends warmup
  # requests to load them into memory.
  # ---------------------------------------------------------------------------
  ollama-init:
    image: curlimages/curl:latest
    container_name: docuchat-ollama-init
    entrypoint: ["/bin/sh", "/scripts/warmup.sh"]
    volumes:
      - ./infra/ollama/warmup.sh:/scripts/warmup.sh:ro
    environment:
      OLLAMA_BASE_URL: http://ollama:11434
      OLLAMA_EMBED_MODEL: nomic-embed-text
      OLLAMA_CHAT_MODEL: gemma:7b
    depends_on:
      ollama:
        condition: service_healthy
    networks:
      - docuchat_net
    restart: "no"

  # ---------------------------------------------------------------------------
  # CURL - Temporary HTTP client (for testing internal connectivity)
  # ---------------------------------------------------------------------------
  curl:
    image: curlimages/curl:latest
    container_name: docuchat-curl
    profiles:
      - tools
    networks:
      - docuchat_net
    entrypoint: ["curl"]

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  docuchat_net:
    driver: bridge
    name: docuchat_net

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  # PostgreSQL data persistence
  postgres_data:
    name: docuchat_postgres_data

  # Redis data persistence (optional, for AOF/RDB)
  redis_data:
    name: docuchat_redis_data

  # Ollama models now use bind mount: ./infra/ollama/models
  # (See ollama service volumes section)

  # Backend file uploads persistence
  backend_uploads:
    name: docuchat_backend_uploads

  # Backend extracted text files persistence
  backend_extracted:
    name: docuchat_backend_extracted